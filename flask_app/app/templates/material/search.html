{% extends "base.html" %}

{% block title %}{{ _('Material Search') }}{% endblock %}

{% block extra_css %}
<style>
.video-card {
    transition: transform 0.2s;
    height: 100%;
}
.video-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.video-thumbnail {
    aspect-ratio: 16/9;
    object-fit: cover;
    width: 100%;
    border-radius: 8px;
}
.video-info {
    padding: 1rem;
}
.video-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    height: 2.4rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
}
.video-meta {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}
.btn-action {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}
.search-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}
.stats-badge {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
}
</style>
{% endblock %}

{% block content %}
<div x-data="materialSearch()" x-init="init()">
    <!-- 页面标题区域 -->
    <div class="search-container">
        <div class="container">
            <div class="text-center">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="bi bi-search me-3"></i>{{ _('Material Search') }}
                </h1>
                <p class="lead mb-4">{{ _('Search and download video materials from various providers') }}</p>
                
                <!-- 搜索表单 -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <input type="text" 
                                               class="form-control form-control-lg" 
                                               x-model="searchQuery"
                                               @keyup.enter="performSearch()"
                                               placeholder="{{ _('Enter keywords to search videos...') }}">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-lg" x-model="selectedProvider">
                                            <template x-for="[key, provider] in Object.entries(providers)" :key="key">
                                                <option :value="key" x-text="provider.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-select-lg" x-model="perPage">
                                            <option value="9">9</option>
                                            <option value="15">15</option>
                                            <option value="21">21</option>
                                            <option value="30">30</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-primary btn-lg w-100" 
                                                @click="performSearch()"
                                                :disabled="isLoading || !searchQuery.trim()">
                                            <i class="bi bi-search me-2" x-show="!isLoading"></i>
                                            <i class="bi bi-arrow-repeat spin me-2" x-show="isLoading"></i>
                                            <span data-i18n="Search">{{ _('Search') }}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="mt-4" x-show="searchResults.length > 0">
                    <div class="stats-badge badge rounded-pill px-4 py-2">
                        <i class="bi bi-collection-play me-2"></i>
                        <span data-i18n="Found {count} results">{{ _('Found') }}</span> <span x-text="searchResults.length"></span> <span data-i18n="results">{{ _('results') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 配置状态提示 -->
    <div class="container mb-4" x-show="!hasConfiguredProviders">
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong data-i18n="Configuration Required">{{ _('Configuration Required') }}</strong>
            <p class="mb-0" data-i18n="Please configure API keys in config/config.yml">{{ _('Please configure API keys in config/config.yml') }}</p>
        </div>
    </div>

    <!-- 搜索结果 -->
    <div class="container">
        <!-- 结果控制栏 -->
        <div class="row mb-4" x-show="searchResults.length > 0">
            <div class="col-md-8">
                <p class="text-muted">
                    <span data-i18n="Search results">{{ _('Search results') }}</span> (<span x-text="searchResults.length"></span>)
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary btn-sm" @click="clearResults()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    <span data-i18n="Clear Results">{{ _('Clear Results') }}</span>
                </button>
            </div>
        </div>

        <!-- 视频网格 -->
        <div class="row g-4" x-show="searchResults.length > 0">
            <template x-for="video in searchResults" :key="`${video.provider}-${video.id}`">
                <div class="col-lg-4 col-md-6">
                    <div class="card video-card h-100 shadow-sm">
                        <img :src="video.thumbnail" 
                             :alt="video.title"
                             class="video-thumbnail"
                             loading="lazy">
                        <div class="video-info">
                            <h6 class="video-title" x-text="video.title"></h6>
                            <div class="video-meta">
                                <i class="bi bi-person me-1"></i><span x-text="video.user"></span>
                                <span class="mx-2">•</span>
                                <i class="bi bi-tag me-1"></i><span x-text="video.provider"></span>
                            </div>
                            <div class="video-meta" x-show="video.duration > 0">
                                <i class="bi bi-clock me-1"></i><span x-text="video.duration"></span>s
                                <span class="mx-2">•</span>
                                <i class="bi bi-aspect-ratio me-1"></i><span x-text="`${video.width}x${video.height}`"></span>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-primary btn-action flex-fill" 
                                        @click="downloadVideo(video)"
                                        :disabled="video.downloading">
                                    <i class="bi bi-download me-1" x-show="!video.downloading"></i>
                                    <i class="bi bi-arrow-repeat spin me-1" x-show="video.downloading"></i>
                                    <span data-i18n="Download" x-show="!video.downloading">{{ _('Download') }}</span>
                                    <span data-i18n="Downloading..." x-show="video.downloading">{{ _('Downloading...') }}</span>
                                </button>
                                <button class="btn btn-outline-primary btn-action flex-fill" 
                                        @click="previewVideo(video)">
                                    <i class="bi bi-eye me-1"></i>
                                    <span data-i18n="Preview">{{ _('Preview') }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- 无结果提示 -->
        <div class="text-center py-5" x-show="searchResults.length === 0 && !isLoading && hasSearched">
            <div class="display-1 text-muted mb-3">
                <i class="bi bi-search"></i>
            </div>
            <h4 data-i18n="No results found">{{ _('No results found') }}</h4>
            <p class="text-muted" data-i18n="Try different keywords or check your API configuration">{{ _('Try different keywords or check your API configuration') }}</p>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-5" x-show="searchResults.length === 0 && !hasSearched">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" data-i18n="How to Use">{{ _('How to Use') }}</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 data-i18n="Configuration">{{ _('Configuration') }}</h6>
                                <p class="small text-muted" data-i18n="Configure API keys in config.yml">{{ _('Configure API keys in config/config.yml:') }}</p>
                                <pre class="bg-light p-2 small"><code>resource:
  pexels:
    api_key: YOUR_PEXELS_API_KEY
  pixabay:
    api_key: YOUR_PIXABAY_API_KEY</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 data-i18n="Supported Providers">{{ _('Supported Providers') }}</h6>
                                <ul class="small">
                                    <li><strong>Pexels</strong>: <span data-i18n="High-quality free videos">{{ _('High-quality free videos') }}</span></li>
                                    <li><strong>Pixabay</strong>: <span data-i18n="Rich free video resources">{{ _('Rich free video resources') }}</span></li>
                                </ul>
                                <h6 data-i18n="Tips">{{ _('Tips') }}</h6>
                                <ul class="small">
                                    <li data-i18n="English keywords work better">{{ _('English keywords work better') }}</li>
                                    <li data-i18n="Downloaded files saved in work/downloads/">{{ _('Downloaded files saved in work/downloads/') }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="Video Preview">{{ _('Video Preview') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <video x-show="selectedVideo" 
                           :src="selectedVideo?.video_url" 
                           class="w-100" 
                           controls 
                           style="max-height: 70vh; border-radius: 8px;">
                        <span data-i18n="Your browser does not support video playback">{{ _('Your browser does not support video playback') }}</span>
                    </video>
                    <div class="mt-3" x-show="selectedVideo">
                        <h6 x-text="selectedVideo?.title"></h6>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <small class="text-muted" data-i18n="Duration">{{ _('Duration') }}</small>
                                <div class="fw-bold" x-text="selectedVideo?.duration || 'Unknown'"></div>
                                <small class="text-muted" data-i18n="seconds">{{ _('seconds') }}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted" data-i18n="Resolution">{{ _('Resolution') }}</small>
                                <div class="fw-bold" x-text="`${selectedVideo?.width}x${selectedVideo?.height}`"></div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted" data-i18n="Provider">{{ _('Provider') }}</small>
                                <div class="fw-bold" x-text="selectedVideo?.provider"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @click="downloadVideo(selectedVideo)" x-show="selectedVideo">
                        <i class="bi bi-download me-2"></i>
                        <span data-i18n="Download Video">{{ _('Download Video') }}</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <span data-i18n="Close">{{ _('Close') }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/material-search.js') }}"></script>
<script type="text/javascript">
// 直接注册Alpine组件
document.addEventListener('alpine:init', () => {
    Alpine.data('materialSearch', materialSearch);
});
</script>
{% endblock %}
