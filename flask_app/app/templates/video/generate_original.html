{% extends "base.html" %}

{% block title %}AIè§†    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold text-primary">
                <i class="bi bi-camera-video-fill me-2"></i>
                AIè§†é¢‘ç”Ÿæˆå·¥ä½œæµ
            </h1>
            <p class="text-muted">é€šè¿‡AIæŠ€æœ¯è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡çŸ­è§†é¢‘å†…å®¹</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-lg" @click="runAutoWorkflow()" 
                    :disabled="!canStartAutoWorkflow() || isAutoRunning" x-show="!isAutoRunning">
                <i class="bi bi-play-circle-fill me-2"></i>
                å…¨è‡ªåŠ¨ç”Ÿæˆ
            </button>
            <button class="btn btn-danger btn-lg" @click="stopAutoWorkflow()" x-show="isAutoRunning">
                <i class="bi bi-stop-circle-fill me-2"></i>
                åœæ­¢æ‰§è¡Œ
            </button>
            <button class="btn btn-outline-secondary" @click="resetWorkflow()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                é‡ç½®å·¥ä½œæµ
            </button>
        </div>
    </div>
    
    <!-- å…¨è‡ªåŠ¨è¿›åº¦æ¡ -->
    <div class="card mb-4" x-show="isAutoRunning || autoProgress > 0">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    å…¨è‡ªåŠ¨ç”Ÿæˆè¿›åº¦
                </h6>
                <span class="badge bg-primary" x-text="`${Math.round(autoProgress)}%`"></span>
            </div>
            <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     :style="`width: ${autoProgress}%`"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" x-text="currentAutoStatus"></small>
                <small class="text-muted" x-text="`æ­¥éª¤ ${currentAutoStep}/5`"></small>
            </div>
        </div>
    </div>eos{% endblock %}

{% block content %}
<div x-data="videoGener                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">éŸ³é¢‘ç±»å‹</label>
                                <select class="form-select" x-model="config.audio.type">
                                    {% for key, value in audio_types.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6" x-show="config.audio.type === 'remote'">
                                <label class="form-label">éŸ³é¢‘è¯­è¨€</label>
                                <select class="form-select" x-model="config.audio.language">
                                    {% for key, value in audio_languages.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>                        <div class="row mb-2" x-show="config.audio.type === 'remote'">
                            <div class="col-6">
                                <label class="form-label">è¯­éŸ³</label>
                                <select class="form-select" x-model="config.audio.voice">
                                    <template x-for="(voices, lang) in {{ audio_voices|tojson }}">
                                        <optgroup :label="lang" x-show="lang === config.audio.language">
                                            <template x-for="(name, key) in voices">
                                                <option :value="key" x-text="name" x-show="lang === config.audio.language"></option>
                                            </template>
                                        </optgroup>
                                    </template>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">è¯­éŸ³é€Ÿåº¦</label>
                                <select class="form-select" x-model="config.audio.speed">
                                    <option value="slowest">æœ€æ…¢</option>
                                    <option value="slower">è¾ƒæ…¢</option>
                                    <option value="slow">æ…¢</option>
                                    <option value="normal">æ­£å¸¸</option>
                                    <option value="fast">å¿«</option>
                                    <option value="faster">è¾ƒå¿«</option>
                                    <option value="fastest">æœ€å¿«</option>
                                </select>
                            </div>
                        </div><!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold text-primary">
                <i class="bi bi-camera-video-fill me-2"></i>
                AIè§†é¢‘ç”Ÿæˆå·¥ä½œæµ
            </h1>
            <p class="text-muted">é€šè¿‡AIæŠ€æœ¯è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡çŸ­è§†é¢‘å†…å®¹</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary" @click="resetWorkflow()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                é‡ç½®å·¥ä½œæµ
            </button>
        </div>
    </div>
    
    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="step-indicator">
                <div class="step-container">
                    <div class="step" :class="getStepClass(1)">
                        <span x-show="!getStepLoading(1)">1</span>
                        <i class="bi bi-arrow-repeat spin" x-show="getStepLoading(1)"></i>
                    </div>
                    <div class="step-label">
                        <h6 class="mb-0">å†…å®¹ç”Ÿæˆ</h6>
                        <small class="text-muted">AIç”Ÿæˆè§†é¢‘è„šæœ¬</small>
                        <div class="step-status" x-show="stepStatus[1]">
                            <small :class="getStepStatusClass(1)" x-text="stepStatus[1]"></small>
                        </div>
                    </div>
                </div>
                
                <div class="step-arrow">â†’</div>
                
                <div class="step-container">
                    <div class="step" :class="getStepClass(2)">
                        <span x-show="!getStepLoading(2)">2</span>
                        <i class="bi bi-arrow-repeat spin" x-show="getStepLoading(2)"></i>
                    </div>
                    <div class="step-label">
                        <h6 class="mb-0">èµ„æºè·å–</h6>
                        <small class="text-muted">åŒ¹é…è§†é¢‘ç´ æ</small>
                        <div class="step-status" x-show="stepStatus[2]">
                            <small :class="getStepStatusClass(2)" x-text="stepStatus[2]"></small>
                        </div>
                    </div>
                </div>
                
                <div class="step-arrow">â†’</div>
                
                <div class="step-container">
                    <div class="step" :class="getStepClass(3)">
                        <span x-show="!getStepLoading(3)">3</span>
                        <i class="bi bi-arrow-repeat spin" x-show="getStepLoading(3)"></i>
                    </div>
                    <div class="step-label">
                        <h6 class="mb-0">è¯­éŸ³åˆæˆ</h6>
                        <small class="text-muted">ç”ŸæˆAIé…éŸ³</small>
                        <div class="step-status" x-show="stepStatus[3]">
                            <small :class="getStepStatusClass(3)" x-text="stepStatus[3]"></small>
                        </div>
                    </div>
                </div>
                
                <div class="step-arrow">â†’</div>
                
                <div class="step-container">
                    <div class="step" :class="getStepClass(4)">
                        <span x-show="!getStepLoading(4)">4</span>
                        <i class="bi bi-arrow-repeat spin" x-show="getStepLoading(4)"></i>
                    </div>
                    <div class="step-label">
                        <h6 class="mb-0">å­—å¹•ç”Ÿæˆ</h6>
                        <small class="text-muted">è‡ªåŠ¨ç”Ÿæˆå­—å¹•</small>
                        <div class="step-status" x-show="stepStatus[4]">
                            <small :class="getStepStatusClass(4)" x-text="stepStatus[4]"></small>
                        </div>
                    </div>
                </div>
                
                <div class="step-arrow">â†’</div>
                
                <div class="step-container">
                    <div class="step" :class="getStepClass(5)">
                        <span x-show="!getStepLoading(5)">5</span>
                        <i class="bi bi-arrow-repeat spin" x-show="getStepLoading(5)"></i>
                    </div>
                    <div class="step-label">
                        <h6 class="mb-0">è§†é¢‘åˆæˆ</h6>
                        <small class="text-muted">ç”Ÿæˆæœ€ç»ˆè§†é¢‘</small>
                        <div class="step-status" x-show="stepStatus[5]">
                            <small :class="getStepStatusClass(5)" x-text="stepStatus[5]"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å·¥ä½œæµæ­¥éª¤å†…å®¹ -->
    <div class="row">
        <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-sliders me-2"></i>
                        ç”Ÿæˆé…ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <!-- åŸºç¡€é…ç½® -->
                    <div class="mb-3">
                        <label class="form-label">è§†é¢‘ä¸»é¢˜</label>
                        <textarea class="form-control" rows="3" x-model="config.topic" 
                                  placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦ç”Ÿæˆçš„è§†é¢‘ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">è§†é¢‘è¯­è¨€</label>
                            <select class="form-select" x-model="config.language">
                                {% for key, value in languages.items() %}
                                <option value="{{ key }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">æ—¶é•¿(ç§’)</label>
                            <input type="number" class="form-control" x-model="config.duration" 
                                   min="30" max="300" value="120">
                        </div>
                    </div>
                    
                    <!-- è§†é¢‘é…ç½® -->
                    <div class="border rounded p-3 mb-3 bg-light">
                        <h6 class="fw-bold mb-3">è§†é¢‘è®¾ç½®</h6>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">å¸ƒå±€</label>
                                <select class="form-select form-select-sm" x-model="config.video.layout" @change="updateVideoSize()">
                                    <option value="landscape">æ¨ªå± (16:9)</option>
                                    <option value="portrait">ç«–å± (9:16)</option>
                                    <option value="square">æ–¹å½¢ (1:1)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">å¸§ç‡</label>
                                <select class="form-select form-select-sm" x-model="config.video.fps">
                                    <option value="20">20 FPS</option>
                                    <option value="25">25 FPS</option>
                                    <option value="30">30 FPS</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" x-model="config.video.enable_transition">
                            <label class="form-check-label">å¯ç”¨è½¬åœºç‰¹æ•ˆ</label>
                        </div>
                    </div>
                    
                    <!-- è¯­éŸ³é…ç½® -->
                    <div class="border rounded p-3 mb-3 bg-light">
                        <h6 class="fw-bold mb-3">è¯­éŸ³è®¾ç½®</h6>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">è¯­éŸ³ç±»å‹</label>
                                <select class="form-select form-select-sm" x-model="config.audio.type">
                                    {% for key, value in audio_types.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6" x-show="config.audio.type === 'remote'">
                                <label class="form-label">è¯­éŸ³è¯­è¨€</label>
                                <select class="form-select form-select-sm" x-model="config.audio.language">
                                    {% for key, value in audio_languages.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2" x-show="config.audio.type === 'remote'">
                            <div class="col-6">
                                <label class="form-label">è¯­éŸ³è§’è‰²</label>
                                <select class="form-select form-select-sm" x-model="config.audio.voice">
                                    {% for lang, voices in audio_voices.items() %}
                                        {% for voice_key, voice_name in voices.items() %}
                                            <option value="{{ voice_key }}" 
                                                    x-show="config.audio.language === '{{ lang }}'">
                                                {{ voice_name }}
                                            </option>
                                        {% endfor %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">è¯­éŸ³é€Ÿåº¦</label>
                                <select class="form-select form-select-sm" x-model="config.audio.speed">
                                    <option value="slowest">æœ€æ…¢</option>
                                    <option value="slower">è¾ƒæ…¢</option>
                                    <option value="slow">æ…¢</option>
                                    <option value="normal">æ­£å¸¸</option>
                                    <option value="fast">å¿«</option>
                                    <option value="faster">è¾ƒå¿«</option>
                                    <option value="fastest">æœ€å¿«</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100" @click="testAudio()">
                            <i class="bi bi-volume-up me-1"></i>
                            è¯•å¬è¯­éŸ³
                        </button>
                    </div>
                    
                    <!-- å­—å¹•é…ç½® -->
                    <div class="border rounded p-3 bg-light">
                        <h6 class="fw-bold mb-3">å­—å¹•è®¾ç½®</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" x-model="config.subtitle.enabled" checked>
                            <label class="form-check-label">å¯ç”¨å­—å¹•</label>
                        </div>
                        <div class="row mb-2" x-show="config.subtitle.enabled">
                            <div class="col-6">
                                <label class="form-label">å­—ä½“</label>
                                <select class="form-select form-select-sm" x-model="config.subtitle.font">
                                    {% for font in subtitle_fonts %}
                                    <option value="{{ font }}">{{ font }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">å¤§å°</label>
                                <select class="form-select form-select-sm" x-model="config.subtitle.size">
                                    <option value="16">16</option>
                                    <option value="18">18</option>
                                    <option value="20">20</option>
                                    <option value="22">22</option>
                                    <option value="24">24</option>
                                    <option value="28">28</option>
                                    <option value="32">32</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2" x-show="config.subtitle.enabled">
                            <div class="col-4">
                                <label class="form-label">ä½ç½®</label>
                                <select class="form-select form-select-sm" x-model="config.subtitle.position">
                                    {% for key, value in subtitle_positions.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="form-label">é¢œè‰²</label>
                                <input type="color" class="form-control form-control-color form-control-sm" 
                                       x-model="config.subtitle.color">
                            </div>
                            <div class="col-4">
                                <label class="form-label">è¾¹æ¡†</label>
                                <select class="form-select form-select-sm" x-model="config.subtitle.border_width">
                                    <option value="0">æ— è¾¹æ¡†</option>
                                    <option value="1">1px</option>
                                    <option value="2">2px</option>
                                    <option value="3">3px</option>
                                    <option value="4">4px</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§å·¥ä½œåŒº -->
        <div class="col-lg-8">
            <!-- æ­¥éª¤1: å†…å®¹ç”Ÿæˆ -->
            <div class="card mb-4" x-show="currentStep >= 1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-text me-2"></i>
                        æ­¥éª¤1: å†…å®¹ç”Ÿæˆ
                    </h5>
                    <button class="btn btn-primary" @click="generateContent()" 
                            :disabled="isLoading || isAutoRunning" x-show="!results.content">
                        <span x-show="!isLoading">
                            <i class="bi bi-magic me-2"></i>ç”Ÿæˆå†…å®¹
                        </span>
                        <span x-show="isLoading">
                            <i class="bi bi-arrow-repeat spin me-2"></i>ç”Ÿæˆä¸­...
                        </span>
                    </button>
                </div>
                <div class="card-body">
                    <div x-show="!results.content && !isLoading" class="text-center text-muted py-4">
                        <i class="bi bi-file-text" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">ç‚¹å‡»"ç”Ÿæˆå†…å®¹"å¼€å§‹AIè„šæœ¬åˆ›ä½œ</p>
                    </div>
                    
                    <div x-show="results.content" class="border rounded p-3 bg-light">
                        <h6 class="fw-bold mb-2">ç”Ÿæˆçš„è§†é¢‘è„šæœ¬:</h6>
                        <div class="content-display" style="max-height: 200px; overflow-y: auto;">
                            <p x-text="results.content" class="mb-0"></p>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <small class="text-muted">å­—æ•°: <span x-text="results.content?.length || 0"></span></small>
                            <button class="btn btn-outline-secondary btn-sm" @click="editContent()">
                                <i class="bi bi-pencil me-1"></i>ç¼–è¾‘
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2: èµ„æºè·å– -->
            <div class="card mb-4" x-show="currentStep >= 2">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-images me-2"></i>
                        æ­¥éª¤2: èµ„æºè·å–
                    </h5>
                    <button class="btn btn-success" @click="getResources()" 
                            :disabled="!results.content || isLoading || isAutoRunning" x-show="!results.resources">
                        <span x-show="!isLoading">
                            <i class="bi bi-download me-2"></i>è·å–èµ„æº
                        </span>
                        <span x-show="isLoading">
                            <i class="bi bi-arrow-repeat spin me-2"></i>è·å–ä¸­...
                        </span>
                    </button>
                </div>
                <div class="card-body">
                    <div x-show="!results.resources && !isLoading" class="text-center text-muted py-4">
                        <i class="bi bi-images" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">ç­‰å¾…è·å–åŒ¹é…çš„è§†é¢‘ç´ æ</p>
                    </div>
                    
                    <div x-show="results.resources" class="row">
                        <template x-for="(resource, index) in results.resources" :key="index">
                            <div class="col-md-4 mb-3">
                                <div class="card border-0 shadow-sm">
                                    <img :src="resource.thumbnail" class="card-img-top" style="height: 120px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="text-muted" x-text="resource.description"></small>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤3: è¯­éŸ³åˆæˆ -->
            <div class="card mb-4" x-show="currentStep >= 3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-mic me-2"></i>
                        æ­¥éª¤3: è¯­éŸ³åˆæˆ
                    </h5>
                    <button class="btn btn-warning" @click="generateAudio()" 
                            :disabled="!results.content || isLoading || isAutoRunning" x-show="!results.audio">
                        <span x-show="!isLoading">
                            <i class="bi bi-volume-up me-2"></i>ç”Ÿæˆé…éŸ³
                        </span>
                        <span x-show="isLoading">
                            <i class="bi bi-arrow-repeat spin me-2"></i>åˆæˆä¸­...
                        </span>
                    </button>
                </div>
                <div class="card-body">
                    <div x-show="!results.audio && !isLoading" class="text-center text-muted py-4">
                        <i class="bi bi-mic" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">ç­‰å¾…ç”ŸæˆAIé…éŸ³</p>
                    </div>
                    
                    <div x-show="results.audio" class="border rounded p-3 bg-light">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="fw-bold mb-1">é…éŸ³å·²ç”Ÿæˆ</h6>
                                <small class="text-muted">æ—¶é•¿: <span x-text="results.audio?.duration || 'æœªçŸ¥'"></span>ç§’</small>
                            </div>
                            <div>
                                <audio controls x-show="results.audio?.url">
                                    <source :src="results.audio?.url" type="audio/mpeg">
                                </audio>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤4: å­—å¹•ç”Ÿæˆ -->
            <div class="card mb-4" x-show="currentStep >= 4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-chat-quote me-2"></i>
                        æ­¥éª¤4: å­—å¹•ç”Ÿæˆ
                    </h5>
                    <button class="btn btn-info" @click="generateSubtitle()" 
                            :disabled="!results.audio || isLoading || isAutoRunning" x-show="!results.subtitle">
                        <span x-show="!isLoading">
                            <i class="bi bi-chat-quote me-2"></i>ç”Ÿæˆå­—å¹•
                        </span>
                        <span x-show="isLoading">
                            <i class="bi bi-arrow-repeat spin me-2"></i>ç”Ÿæˆä¸­...
                        </span>
                    </button>
                </div>
                <div class="card-body">
                    <div x-show="!results.subtitle && !isLoading" class="text-center text-muted py-4">
                        <i class="bi bi-chat-quote" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">ç­‰å¾…ç”Ÿæˆå­—å¹•æ–‡ä»¶</p>
                    </div>
                    
                    <div x-show="results.subtitle" class="border rounded p-3 bg-light">
                        <h6 class="fw-bold mb-2">å­—å¹•é¢„è§ˆ:</h6>
                        <div style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                            <template x-for="(sub, index) in results.subtitle?.lines" :key="index">
                                <div class="mb-1">
                                    <small class="text-muted" x-text="sub.timestamp"></small>
                                    <span x-text="sub.text"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤5: è§†é¢‘åˆæˆ -->
            <div class="card mb-4" x-show="currentStep >= 5">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-film me-2"></i>
                        æ­¥éª¤5: è§†é¢‘åˆæˆ
                    </h5>
                    <button class="btn btn-danger" @click="generateVideo()" 
                            :disabled="!canGenerateVideo() || isLoading || isAutoRunning" x-show="!results.video">
                        <span x-show="!isLoading">
                            <i class="bi bi-film me-2"></i>ç”Ÿæˆè§†é¢‘
                        </span>
                        <span x-show="isLoading">
                            <i class="bi bi-arrow-repeat spin me-2"></i>åˆæˆä¸­...
                        </span>
                    </button>
                </div>
                <div class="card-body">
                    <div x-show="!results.video && !isLoading" class="text-center text-muted py-4">
                        <i class="bi bi-film" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">ç­‰å¾…åˆæˆæœ€ç»ˆè§†é¢‘</p>
                    </div>
                    
                    <!-- åˆæˆè¿›åº¦ -->
                    <div x-show="isLoading && currentStep === 5" class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">è§†é¢‘åˆæˆè¿›åº¦</span>
                            <span x-text="progress + '%'"></span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 :style="'width: ' + progress + '%'"></div>
                        </div>
                        <small class="text-muted">è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...</small>
                    </div>
                    
                    <!-- æœ€ç»ˆç»“æœ -->
                    <div x-show="results.video" class="border rounded p-3 bg-light">
                        <div class="text-center">
                            <video controls class="w-100" style="max-height: 400px;" x-show="results.video?.url">
                                <source :src="results.video?.url" type="video/mp4">
                            </video>
                            <div class="mt-3">
                                <h5 class="fw-bold text-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    è§†é¢‘ç”Ÿæˆå®Œæˆï¼
                                </h5>
                                <div class="d-flex justify-content-center gap-3 mt-3">
                                    <a :href="results.video?.download_url" class="btn btn-success" download>
                                        <i class="bi bi-download me-2"></i>
                                        ä¸‹è½½è§†é¢‘
                                    </a>
                                    <button class="btn btn-primary" @click="shareVideo()">
                                        <i class="bi bi-share me-2"></i>
                                        åˆ†äº«
                                    </button>
                                    <a href="{{ url_for('publish.batch') }}" class="btn btn-info">
                                        <i class="bi bi-cloud-upload me-2"></i>
                                        å‘å¸ƒè§†é¢‘
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.step-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    min-width: 140px;
}

.step {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    position: relative;
    transition: all 0.3s ease;
}

.step-label {
    text-align: center;
    margin-top: 8px;
}

.step-status {
    margin-top: 4px;
}

.step-arrow {
    font-size: 1.5rem;
    color: #6c757d;
    margin: 0 10px;
}

.text-success {
    color: #198754 !important;
}

.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 0 0; }
    100% { background-position: 40px 0; }
}

@media (max-width: 768px) {
    .step-indicator {
        flex-direction: column;
    }
    
    .step-arrow {
        transform: rotate(90deg);
        margin: 10px 0;
    }
    
    .step-container {
        min-width: auto;
        width: 100%;
    }
}
</style>

<script>
function videoGeneratePage() {
    return {
        currentStep: 1,
        isLoading: false,
        progress: 0,
        
        // å…¨è‡ªåŠ¨å·¥ä½œæµç›¸å…³
        isAutoRunning: false,
        autoProgress: 0,
        currentAutoStep: 0,
        currentAutoStatus: 'ç­‰å¾…å¼€å§‹...',
        autoAbortController: null,
        
        // æ­¥éª¤çŠ¶æ€å’ŒåŠ è½½çŠ¶æ€
        stepStatus: {
            1: null,
            2: null,
            3: null,
            4: null,
            5: null
        },
        stepLoading: {
            1: false,
            2: false,
            3: false,
            4: false,
            5: false
        },
        
        config: {
            topic: '',
            language: 'zh-CN',
            duration: 120,
            video: {
                layout: 'landscape',  // é»˜è®¤æ”¹ä¸ºæ¨ªå±
                fps: '30',
                size: '1280x720',
                enable_transition: true
            },
            audio: {
                type: 'remote',
                language: 'zh-CN',
                voice: 'aicheng',
                speed: 'normal'
            },
            subtitle: {
                enabled: true,
                font: 'PingFang SC Regular',
                size: 24,
                position: 2,
                color: '#FFFFFF',
                border_color: '#000000',
                border_width: 0
            }
        },
        
        results: {
            content: null,
            resources: null,
            audio: null,
            subtitle: null,
            video: null
        },
        
        getStepClass(step) {
            if (this.stepLoading[step]) return 'active bg-warning';
            if (step < this.currentStep) return 'completed bg-success text-white';
            if (step === this.currentStep) return 'active bg-primary text-white';
            return 'bg-secondary text-white';
        },
        
        getStepLoading(step) {
            return this.stepLoading[step];
        },
        
        getStepStatusClass(step) {
            const status = this.stepStatus[step];
            if (!status) return '';
            if (status.includes('æˆåŠŸ') || status.includes('å®Œæˆ')) return 'text-success';
            if (status.includes('è¿›è¡Œä¸­') || status.includes('å¤„ç†ä¸­')) return 'text-warning';
            if (status.includes('å¤±è´¥') || status.includes('é”™è¯¯')) return 'text-danger';
            return 'text-muted';
        },
        
        setStepStatus(step, status, loading = false) {
            this.stepStatus[step] = status;
            this.stepLoading[step] = loading;
        },
        
        canStartAutoWorkflow() {
            return this.config.topic.trim().length > 10 && !this.isAutoRunning;
        },
        
        async runAutoWorkflow() {
            if (!this.canStartAutoWorkflow()) {
                showToast('è¯·å…ˆè¾“å…¥è§†é¢‘ä¸»é¢˜ï¼ˆè‡³å°‘10ä¸ªå­—ç¬¦ï¼‰', 'warning');
                return;
            }
            
            this.isAutoRunning = true;
            this.autoProgress = 0;
            this.currentAutoStep = 0;
            this.autoAbortController = new AbortController();
            
            // é‡ç½®æ‰€æœ‰ç»“æœå’ŒçŠ¶æ€
            this.resetWorkflow(false);
            
            try {
                // æ­¥éª¤1: ç”Ÿæˆå†…å®¹
                await this.autoStep1();
                if (!this.isAutoRunning) return;
                
                // æ­¥éª¤2: è·å–èµ„æº
                await this.autoStep2();
                if (!this.isAutoRunning) return;
                
                // æ­¥éª¤3: ç”ŸæˆéŸ³é¢‘
                await this.autoStep3();
                if (!this.isAutoRunning) return;
                
                // æ­¥éª¤4: ç”Ÿæˆå­—å¹•
                await this.autoStep4();
                if (!this.isAutoRunning) return;
                
                // æ­¥éª¤5: ç”Ÿæˆè§†é¢‘
                await this.autoStep5();
                
                // å®Œæˆ
                this.autoProgress = 100;
                this.currentAutoStatus = 'å…¨éƒ¨å®Œæˆï¼ğŸ‰';
                showToast('è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 'success');
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Auto workflow error:', error);
                    this.currentAutoStatus = `é”™è¯¯: ${error.message}`;
                    showToast('è‡ªåŠ¨ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'error');
                }
            } finally {
                this.isAutoRunning = false;
            }
        },
        
        stopAutoWorkflow() {
            this.isAutoRunning = false;
            this.currentAutoStatus = 'å·²åœæ­¢';
            if (this.autoAbortController) {
                this.autoAbortController.abort();
            }
            // åœæ­¢æ‰€æœ‰æ­¥éª¤çš„åŠ è½½çŠ¶æ€
            for (let i = 1; i <= 5; i++) {
                this.stepLoading[i] = false;
            }
            showToast('è‡ªåŠ¨ç”Ÿæˆå·²åœæ­¢', 'info');
        },
        
        async autoStep1() {
            this.currentAutoStep = 1;
            this.currentAutoStatus = 'æ­£åœ¨ç”Ÿæˆè§†é¢‘è„šæœ¬...';
            this.setStepStatus(1, 'æ­£åœ¨ç”Ÿæˆè„šæœ¬...', true);
            this.autoProgress = 5;
            
            try {
                const response = await fetch('/api/video/generate_content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: this.config.topic,
                        language: this.config.language,
                        duration: this.config.duration
                    }),
                    signal: this.autoAbortController.signal
                });
                
                if (!response.ok) throw new Error('å†…å®¹ç”Ÿæˆå¤±è´¥');
                
                const result = await response.json();
                this.results.content = result.data.content;
                this.currentStep = Math.max(this.currentStep, 2);
                this.autoProgress = 20;
                this.setStepStatus(1, 'è„šæœ¬ç”Ÿæˆå®Œæˆ âœ“', false);
                
            } catch (error) {
                this.setStepStatus(1, 'è„šæœ¬ç”Ÿæˆå¤±è´¥ âœ—', false);
                throw error;
            }
        },
        
        async autoStep2() {
            this.currentAutoStep = 2;
            this.currentAutoStatus = 'æ­£åœ¨åŒ¹é…è§†é¢‘ç´ æ...';
            this.setStepStatus(2, 'æ­£åœ¨è·å–èµ„æº...', true);
            this.autoProgress = 25;
            
            try {
                const response = await fetch('/api/video/get_resources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.results.content
                    }),
                    signal: this.autoAbortController.signal
                });
                
                if (!response.ok) throw new Error('èµ„æºè·å–å¤±è´¥');
                
                const result = await response.json();
                this.results.resources = result.data.resources;
                this.currentStep = Math.max(this.currentStep, 3);
                this.autoProgress = 40;
                this.setStepStatus(2, `èµ„æºè·å–å®Œæˆ âœ“ (${result.data.resources?.length || 0}ä¸ª)`, false);
                
            } catch (error) {
                this.setStepStatus(2, 'èµ„æºè·å–å¤±è´¥ âœ—', false);
                throw error;
            }
        },
        
        async autoStep3() {
            this.currentAutoStep = 3;
            this.currentAutoStatus = 'æ­£åœ¨ç”ŸæˆAIé…éŸ³...';
            this.setStepStatus(3, 'æ­£åœ¨åˆæˆè¯­éŸ³...', true);
            this.autoProgress = 45;
            
            try {
                const response = await fetch('/api/video/generate_dubbing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: this.results.content,
                        audio_type: this.config.audio.type,
                        voice: this.config.audio.voice,
                        audio_speed: this.config.audio.speed
                    }),
                    signal: this.autoAbortController.signal
                });
                
                if (!response.ok) throw new Error('è¯­éŸ³åˆæˆå¤±è´¥');
                
                const result = await response.json();
                this.results.audio = result.data;
                this.currentStep = Math.max(this.currentStep, 4);
                this.autoProgress = 60;
                this.setStepStatus(3, `è¯­éŸ³åˆæˆå®Œæˆ âœ“`, false);
                
            } catch (error) {
                this.setStepStatus(3, 'è¯­éŸ³åˆæˆå¤±è´¥ âœ—', false);
                throw error;
            }
        },
        
        async autoStep4() {
            this.currentAutoStep = 4;
            this.currentAutoStatus = 'æ­£åœ¨ç”Ÿæˆå­—å¹•...';
            this.setStepStatus(4, 'æ­£åœ¨ç”Ÿæˆå­—å¹•...', true);
            this.autoProgress = 65;
            
            try {
                const response = await fetch('/api/video/generate_subtitle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audio_file: this.results.audio?.file || '',
                        content: this.results.content,
                        language: this.config.language
                    }),
                    signal: this.autoAbortController.signal
                });
                
                if (!response.ok) throw new Error('å­—å¹•ç”Ÿæˆå¤±è´¥');
                
                const result = await response.json();
                this.results.subtitle = result.data;
                this.currentStep = Math.max(this.currentStep, 5);
                this.autoProgress = 80;
                this.setStepStatus(4, 'å­—å¹•ç”Ÿæˆå®Œæˆ âœ“', false);
                
            } catch (error) {
                this.setStepStatus(4, 'å­—å¹•ç”Ÿæˆå¤±è´¥ âœ—', false);
                throw error;
            }
        },
        
        async autoStep5() {
            this.currentAutoStep = 5;
            this.currentAutoStatus = 'æ­£åœ¨åˆæˆæœ€ç»ˆè§†é¢‘...';
            this.setStepStatus(5, 'æ­£åœ¨åˆæˆè§†é¢‘...', true);
            this.autoProgress = 85;
            
            try {
                const response = await fetch('/api/video/generate_final', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audio_file: this.results.audio?.file || '',
                        subtitle_file: this.results.subtitle?.file || '',
                        resources: this.results.resources || [],
                        enable_subtitle: this.config.subtitle.enabled,
                        video_layout: this.config.video.layout,
                        video_fps: parseInt(this.config.video.fps),
                        enable_transition: this.config.video.enable_transition
                    }),
                    signal: this.autoAbortController.signal
                });
                
                if (!response.ok) throw new Error('è§†é¢‘åˆæˆå¤±è´¥');
                
                const result = await response.json();
                this.results.video = result.data;
                this.autoProgress = 100;
                this.setStepStatus(5, 'è§†é¢‘åˆæˆå®Œæˆ âœ“', false);
                
            } catch (error) {
                this.setStepStatus(5, 'è§†é¢‘åˆæˆå¤±è´¥ âœ—', false);
                throw error;
            }
        },
        
        async generateContent() {
            if (!this.config.topic.trim()) {
                showToast('è¯·è¾“å…¥è§†é¢‘ä¸»é¢˜', 'warning');
                return;
            }
            
            this.isLoading = true;
            this.setStepStatus(1, 'æ­£åœ¨ç”Ÿæˆè„šæœ¬...', true);
            
            try {
                const response = await apiRequest('/api/video/generate_content', {
                    topic: this.config.topic,
                    language: this.config.language,
                    duration: this.config.duration
                }, 'POST');
                
                this.results.content = response.data.content;
                this.currentStep = Math.max(this.currentStep, 2);
                this.setStepStatus(1, 'è„šæœ¬ç”Ÿæˆå®Œæˆ âœ“', false);
                showToast('å†…å®¹ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                this.setStepStatus(1, 'è„šæœ¬ç”Ÿæˆå¤±è´¥ âœ—', false);
                showToast('å†…å®¹ç”Ÿæˆå¤±è´¥', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async getResources() {
            this.isLoading = true;
            this.setStepStatus(2, 'æ­£åœ¨è·å–èµ„æº...', true);
            
            try {
                const response = await apiRequest('/api/video/get_resources', {
                    content: this.results.content
                }, 'POST');
                
                this.results.resources = response.data.resources;
                this.currentStep = Math.max(this.currentStep, 3);
                this.setStepStatus(2, `èµ„æºè·å–å®Œæˆ âœ“ (${response.data.resources?.length || 0}ä¸ª)`, false);
                showToast('èµ„æºè·å–æˆåŠŸï¼', 'success');
            } catch (error) {
                this.setStepStatus(2, 'èµ„æºè·å–å¤±è´¥ âœ—', false);
                showToast('èµ„æºè·å–å¤±è´¥', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async generateAudio() {
            this.isLoading = true;
            this.setStepStatus(3, 'æ­£åœ¨åˆæˆè¯­éŸ³...', true);
            
            try {
                const response = await apiRequest('/api/video/generate_dubbing', {
                    content: this.results.content,
                    audio_type: this.config.audio.type,
                    voice: this.config.audio.voice,
                    audio_speed: this.config.audio.speed
                }, 'POST');
                
                this.results.audio = response.data;
                this.currentStep = Math.max(this.currentStep, 4);
                this.setStepStatus(3, 'è¯­éŸ³åˆæˆå®Œæˆ âœ“', false);
                showToast('è¯­éŸ³åˆæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                this.setStepStatus(3, 'è¯­éŸ³åˆæˆå¤±è´¥ âœ—', false);
                showToast('è¯­éŸ³åˆæˆå¤±è´¥', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async generateSubtitle() {
            this.isLoading = true;
            this.setStepStatus(4, 'æ­£åœ¨ç”Ÿæˆå­—å¹•...', true);
            
            try {
                const response = await apiRequest('/api/video/generate_subtitle', {
                    audio_file: this.results.audio?.file || '',
                    content: this.results.content,
                    language: this.config.language
                }, 'POST');
                
                this.results.subtitle = response.data;
                this.currentStep = Math.max(this.currentStep, 5);
                this.setStepStatus(4, 'å­—å¹•ç”Ÿæˆå®Œæˆ âœ“', false);
                showToast('å­—å¹•ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                this.setStepStatus(4, 'å­—å¹•ç”Ÿæˆå¤±è´¥ âœ—', false);
                showToast('å­—å¹•ç”Ÿæˆå¤±è´¥', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async generateVideo() {
            this.isLoading = true;
            this.progress = 0;
            this.setStepStatus(5, 'æ­£åœ¨åˆæˆè§†é¢‘...', true);
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const progressInterval = setInterval(() => {
                if (this.progress < 90) {
                    this.progress += Math.random() * 10;
                }
            }, 500);
            
            try {
                const response = await apiRequest('/api/video/generate_final', {
                    audio_file: this.results.audio?.file || '',
                    subtitle_file: this.results.subtitle?.file || '',
                    resources: this.results.resources || [],
                    enable_subtitle: this.config.subtitle.enabled,
                    video_layout: this.config.video.layout,
                    video_fps: parseInt(this.config.video.fps),
                    enable_transition: this.config.video.enable_transition
                }, 'POST');
                
                clearInterval(progressInterval);
                this.progress = 100;
                
                this.results.video = response.data;
                this.setStepStatus(5, 'è§†é¢‘åˆæˆå®Œæˆ âœ“', false);
                showToast('è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 'success');
            } catch (error) {
                clearInterval(progressInterval);
                this.setStepStatus(5, 'è§†é¢‘åˆæˆå¤±è´¥ âœ—', false);
                showToast('è§†é¢‘ç”Ÿæˆå¤±è´¥', 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        async testAudio() {
            try {
                const response = await apiRequest('/api/video/test_audio', {
                    text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•éŸ³é¢‘ï¼Œç”¨äºé¢„è§ˆè¯­éŸ³æ•ˆæœ',
                    voice_config: this.config.audio
                }, 'POST');
                
                if (response.data.audio_url) {
                    const audio = new Audio(response.data.audio_url);
                    audio.play();
                }
            } catch (error) {
                showToast('è¯­éŸ³æµ‹è¯•å¤±è´¥', 'error');
            }
        },
        
        canGenerateVideo() {
            return this.results.content && 
                   this.results.resources && 
                   this.results.audio && 
                   (this.config.subtitle.enabled ? this.results.subtitle : true);
        },
        
        resetWorkflow(showToastMessage = true) {
            this.currentStep = 1;
            this.results = {
                content: null,
                resources: null,
                audio: null,
                subtitle: null,
                video: null
            };
            this.progress = 0;
            this.autoProgress = 0;
            this.currentAutoStep = 0;
            this.currentAutoStatus = 'ç­‰å¾…å¼€å§‹...';
            
            // é‡ç½®æ­¥éª¤çŠ¶æ€
            for (let i = 1; i <= 5; i++) {
                this.stepStatus[i] = null;
                this.stepLoading[i] = false;
            }
            
            if (showToastMessage) {
                showToast('å·¥ä½œæµå·²é‡ç½®', 'info');
            }
        },
        
        editContent() {
            const newContent = prompt('ç¼–è¾‘è§†é¢‘è„šæœ¬:', this.results.content);
            if (newContent && newContent.trim()) {
                this.results.content = newContent.trim();
                showToast('å†…å®¹å·²æ›´æ–°', 'success');
            }
        },
        
        shareVideo() {
            if (navigator.share && this.results.video?.url) {
                navigator.share({
                    title: 'AIç”Ÿæˆçš„è§†é¢‘',
                    text: 'ä½¿ç”¨MincodeVideosç”Ÿæˆçš„AIè§†é¢‘',
                    url: this.results.video.url
                });
            } else {
                navigator.clipboard.writeText(this.results.video?.url || '').then(() => {
                    showToast('è§†é¢‘é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            }
        },
        
        updateVideoSize() {
            const layout = this.config.video.layout;
            if (layout === 'landscape') {
                this.config.video.size = '1280x720';
            } else if (layout === 'portrait') {
                this.config.video.size = '720x1280';
            } else { // square
                this.config.video.size = '720x720';
            }
        }
    }
}
</script>
{% endblock %}